import { ITask } from '../Task';
import { modelProvider } from '../../services/ModelProvider';
import { Vulnerability } from '../../model/entity/Vulnerability';

export class AddVulneravilityTask implements ITask<Array<string>, void> {
  public async run(components: Array<string>): Promise<void> {
    const response = await this.getVulnerabilities(components); // TODO: remove mock up and call gRPC service
    const vulnerabilities = this.groupVulnerabilitiesByCVE(response);
    await modelProvider.model.vulnerability.insertAll(vulnerabilities);
    await modelProvider.model.vulnerability.insertComponentVulnerabilityFromGRPC(
      response.purls
    );
  }

  private groupVulnerabilitiesByCVE(
    vulnerabilities: any
  ): Array<Vulnerability> {
    const vul: Record<string, Vulnerability> = {};
    vulnerabilities.purls.forEach((p) => {
      p.vulnerabilities.forEach((v) => {
        if (!vul[v.cve]) vul[v.cve] = Object.assign(new Vulnerability(), v);
      });
    });
    return Object.values(vul);
  }

  private async getVulnerabilities(components: Array<string>) {
    return {
      purls: [
        {
          purl: 'pkg:github/scanoss/minr@1.18',
          vulnerabilities: [
            {
              id: '',
              cve: 'CVE-2018-8088',
              url: 'url1',
              summary: '',
              severity: 'CRITICAL',
              introduced: 'a',
              reported: 'a',
              patched: 'a',
              source: 'a',
            },
            {
              id: '',
              cve: 'CVE-2018-8090',
              url: 'b',
              summary: 'b',
              severity: 'CRITICAL',
              introduced: 'b',
              reported: 'b',
              patched: 'b',
              source: 'b',
            },
          ],
        },
        {
          purl: 'pkg:github/scanoss/minr@2.0.6',
          vulnerabilities: [
            {
              id: '',
              cve: 'CVE-2018-8088',
              url: 'url1',
              summary: 'c',
              severity: 'CRITICAL',
              introduced: '',
              reported: '',
              patched: '',
              source: '',
            },
            {
              id: '',
              cve: 'CVE-2018-8089',
              url: '',
              summary: '',
              severity: 'CRITICAL',
              introduced: '',
              reported: '',
              patched: '',
              source: '',
            },
          ],
        },
      ],
    };
  }
}
