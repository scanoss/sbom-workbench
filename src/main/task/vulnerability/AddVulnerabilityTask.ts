import log from 'electron-log';
import AppConfig from '../../../config/AppConfigModule';
import { ITask } from '../Task';
import { modelProvider } from '../../services/ModelProvider';
import { Vulnerability } from '../../model/entity/Vulnerability';
// eslint-disable-next-line import/extensions
import { VulnerabilityScanner, Component, ComponentsVulnerabilitiesResponse, VulnerabilityCfg } from 'scanoss';
import { ScannerFactory } from '../scanner/ScannerFactory';


export interface IVulnerabilityTask {
  components: Array<string>;
  force?:boolean;
}

export class AddVulnerabilityTask implements ITask<IVulnerabilityTask, void> {

  private async insertVulnerabilities(response: ComponentsVulnerabilitiesResponse) {
    const vulnerabilities = this.groupVulnerabilitiesByCVE(response);
    if (vulnerabilities.length > 0) {
      await modelProvider.model.vulnerability.insertAll(vulnerabilities);
      await modelProvider.model.vulnerability.insertComponentVulnerability(response);
    }
  }

  private async scanVulnerabilities(components: Array<string>) {
    const scanner = ScannerFactory.createScanner(VulnerabilityCfg, VulnerabilityScanner);
    const componentRequest = components.map((c) => { return { purl: c } });
    return await scanner.getVulnerabilitiesComponents(componentRequest);
  }

  private getHighestCvss(cvssArray: any[]): any | null {
    if (!cvssArray || cvssArray.length === 0) return null;

    const getVersion = (cvssString: string): number => {
      if (!cvssString) return 0;
      const match = cvssString.match(/CVSS:(\d+\.?\d*)/);
      return match ? parseFloat(match[1]) : 0;
    };

    return [...cvssArray].sort((a, b) => getVersion(b.cvss) - getVersion(a.cvss))[0];
  }

  private groupVulnerabilitiesByCVE(vulnerabilities: ComponentsVulnerabilitiesResponse): Array<Vulnerability> {
    const vul: Record<string, Vulnerability> = {};
    vulnerabilities.components.forEach((p) => {
      p.vulnerabilities.forEach((v) => {
        const key = `${v.cve}${v.id}`;
        if (!vul[key]) {
          const highestCvss = this.getHighestCvss(v.cvss);
          vul[key] = Object.assign(new Vulnerability(), {...v,
            external_id: v.id,
            cvss_severity: highestCvss?.cvss_severity || '',
            cvss_score: highestCvss?.cvss_score || '',
            cvss: highestCvss?.cvss || ''
          });
        }
      });
    });
    return Object.values(vul);
  }

  public async run(params: IVulnerabilityTask): Promise<void> {
    try {
      if (!AppConfig.FF_ENABLE_SCAN_VULNERABILITY) return;
      log.info(`[Vulnerability Task]: Components to analyze: ${JSON.stringify(params.components, null, 2)}`);
      const response = await this.scanVulnerabilities(params.components);
      // Delete All vulnerabilities if force flag is true
      if (params.force) await modelProvider.model.vulnerability.deleteAll();
      await this.insertVulnerabilities(response);
    } catch (err: any) {
      log.error('[Add Vulnerability Task]:', err);
      throw err;
    }
  }
}
