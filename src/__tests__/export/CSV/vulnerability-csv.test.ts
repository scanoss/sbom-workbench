import { CryptographyCsv } from '../../../main/modules/export/format/CSV/Cryptography-csv';
import { ExportSource, ExportStatusCode } from '../../../api/types';
import { ExportRepositoryMock } from '../ExportRepositoryMock';
import { VulnerabilityCsv } from '../../../main/modules/export/format/CSV/Vulnerability-csv';


jest.mock('electron', () => ({
  app: {
    getPath: jest.fn(() => '/mock/path'),
    getName: jest.fn(() => 'MockAppName'),
    getVersion: jest.fn(() => '1.0.0'),
    // Add any other app methods you're using in your code
  },
  ipcMain: {
    on: jest.fn(),
    send: jest.fn(),
  },
  // Add any other Electron modules you're using
}));

// If you're using electron-log, you might want to mock it as well
jest.mock('electron-log', () => ({
  info: jest.fn(),
  error: jest.fn(),
  warn: jest.fn(),
  debug: jest.fn(),
  // Add any other methods from electron-log that you're using
}));

describe('Vulnerability CSV report tests', () => {
  let exportRepositoryMock: ExportRepositoryMock;
  beforeEach(() => {
    exportRepositoryMock = new ExportRepositoryMock();
  });

  it('Vulnerability CSV identified report test', async () => {
    const cryptoExport = new VulnerabilityCsv(ExportSource.IDENTIFIED, exportRepositoryMock);
    const { report, status } = await cryptoExport.generate();
    expect(status.code).toEqual(ExportStatusCode.SUCCESS);
    console.log(report);
    // Parse the CSV string manually
    const lines = report.trim().split('\n');
    expect(lines.length).toBeGreaterThan(1); // At least header + one data row

    // Get and validate headers
    const headers = lines[0].split(',').map((header) => header.trim());
    const expectedHeaders = ['purl','version','id','cve','source','severity','modified','published','url'];
    expectedHeaders.forEach((header) => {
      expect(headers).toContain(header);
    });

    const expectedPurls = ['pkg:github/scanoss/scanner.c'];
    const expectedVersions = ['1.0.0', '1.2.3'];
    const expectedExternalVulnerabilitiesIds = ['CVE-2017-6507'];
    const expectedCVEs = ['CVE-2017-6507'];
    const expectedSources = ['NDV'];
    const expectedSeverities = ['MEDIUM'];
    const expectedURLs= ['https://osv.dev/vulnerability/CVE-2017-6507'];
    // Validate output
    for (let i = 1; i < lines.length; i++) {
      const columns = lines[i].split(',').map((column) => column.trim());
      console.log(columns[0]);
      expect(expectedPurls).toContain(columns[0]);
      expect(expectedVersions).toContain(columns[1]);
      expect(expectedExternalVulnerabilitiesIds).toContain(columns[2]);
      expect(expectedCVEs).toContain(columns[3]);
      expect(expectedSources).toContain(columns[4]);
      expect(expectedSeverities).toContain(columns[5]);
      expect(expectedURLs).toContain(columns[8]);
    }
  });

  it('Vulnerability CSV identified report test', async () => {
    const cryptoExport = new VulnerabilityCsv(ExportSource.DETECTED, exportRepositoryMock);
    const { report, status } = await cryptoExport.generate();
    expect(status.code).toEqual(ExportStatusCode.SUCCESS);
    console.log(report);
    // Parse the CSV string manually
    const lines = report.trim().split('\n');
    expect(lines.length).toBeGreaterThan(1); // At least header + one data row

    // Get and validate headers
    const headers = lines[0].split(',').map((header) => header.trim());
    const expectedHeaders = ['purl','version','id','cve','source','severity','modified','published','url'];
    expectedHeaders.forEach((header) => {
      expect(headers).toContain(header);
    });

    const expectedPurls = ['pkg:github/scanoss/scanner.c'];
    const expectedVersions = ['1.0.0', '1.2.3'];
    const expectedExternalVulnerabilitiesIds = ['CVE-2017-6507'];
    const expectedCVEs = ['CVE-2017-6507'];
    const expectedSources = ['NDV'];
    const expectedSeverities = ['MEDIUM'];
    const expectedURLs= ['https://osv.dev/vulnerability/CVE-2017-6507'];
    // Validate output
    for (let i = 1; i < lines.length; i++) {
      const columns = lines[i].split(',').map((column) => column.trim());
      console.log(columns[0]);
      expect(expectedPurls).toContain(columns[0]);
      expect(expectedVersions).toContain(columns[1]);
      expect(expectedExternalVulnerabilitiesIds).toContain(columns[2]);
      expect(expectedCVEs).toContain(columns[3]);
      expect(expectedSources).toContain(columns[4]);
      expect(expectedSeverities).toContain(columns[5]);
      expect(expectedURLs).toContain(columns[8]);
    }
  });


});
