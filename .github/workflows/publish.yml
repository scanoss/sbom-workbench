name: Publish

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*.*.*'

jobs:
  # Build Windows (unsigned)
  build-windows:
    uses: ./.github/workflows/_build-windows.yml
    secrets:
      SC_GH_TAG_TOKEN: ${{ secrets.SC_GH_TAG_TOKEN }}

  # Sign Windows artifacts
  sign-windows:
    needs: [build-windows]
    uses: ./.github/workflows/_sign-windows.yml
    secrets:
      ES_USERNAME: ${{ secrets.ES_USERNAME }}
      ES_PASSWORD: ${{ secrets.ES_PASSWORD }}
      CREDENTIAL_ID: ${{ secrets.CREDENTIAL_ID }}
      ES_TOTP_SECRET: ${{ secrets.ES_TOTP_SECRET }}

  # Build macOS (signed and notarized)
  build-macos:
    uses: ./.github/workflows/_build-macos.yml
    secrets:
      SC_GH_TAG_TOKEN: ${{ secrets.SC_GH_TAG_TOKEN }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_ID_PASS: ${{ secrets.APPLE_ID_PASS }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      CSC_LINK: ${{ secrets.CSC_LINK }}
      CSC_KEY_PASSWORD: ${{ secrets.CSC_KEY_PASSWORD }}

  # Build Linux
  build-linux:
    uses: ./.github/workflows/_build-linux.yml
    secrets:
      SC_GH_TAG_TOKEN: ${{ secrets.SC_GH_TAG_TOKEN }}

  # Create GitHub Release
  create-release:
    needs: [sign-windows, build-macos, build-linux]
    runs-on: ubuntu-latest

    steps:
      - name: Download Windows artifacts
        uses: actions/download-artifact@v6
        with:
          name: artifact_w

      - name: Download macOS artifacts
        uses: actions/download-artifact@v6
        with:
          name: artifact_m

      - name: Download Linux artifacts
        uses: actions/download-artifact@v6
        with:
          name: artifact_l

      - name: List all artifacts
        run: ls -la

      - name: Publish release draft
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_PROMPT_DISABLED: "disable"
        run: |
          gh release create ${{ github.ref_name }} \
            --repo ${{ github.server_url }}/${{ github.repository }} \
            --generate-notes \
            --draft \
            $(ls *.AppImage *.exe *.dmg *.zip *.yml *.blockmap 2>/dev/null || true)